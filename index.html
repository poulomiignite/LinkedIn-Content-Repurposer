const generateImage = async (item, index, type = 'social') => {
                const key = type === 'blog' ? 'blog' : index;
                if (generatingImages[key]) return;

                setGeneratingImages(prev => ({ ...prev, [key]: true }));
                
                let enhancedPrompt = '';
                
                if (type === 'blog') {
                    // Updated Blog Prompt to include the gradient strip and text
                    enhancedPrompt = `16:9 Landscape format blog header image created by Nano Banana Pro. Background: High-end, premium photography featuring diverse professionals or people in modern, soft-toned environments relevant to: ${item.visual_description}. Lighting: Soft, warm, natural, human-centric. Design: Overlaying the image is a semi-transparent (85% opacity), premium horizontal text strip/box with a smooth gradient background (fading from Bold Fuschia to Deep Purple). The background image should be faintly visible through the gradient strip. Text: "${item.title}" is written clearly in White, modern sans-serif font inside this gradient strip. Style: Nano Banana Pro premium aesthetic, Luxurious, soft glows, elegant gradients, high-contrast text block.`;
                } else {
                    // Updated Social Prompt to ensure specific strip style
                    enhancedPrompt = `Square format social media graphic created by Nano Banana Pro. Background: High-end, premium photography featuring diverse professionals or people in modern, soft-toned environments relevant to: ${item.visual_description}. Lighting: Soft, warm, natural, human-centric. Design: Overlaying the image is a semi-transparent (85% opacity), premium horizontal text strip/box with a smooth gradient background (fading from Bold Fuschia to Deep Purple). The background image should be faintly visible through the gradient strip. Text: "${item.hook_text}" is written clearly in White, modern sans-serif font inside this gradient strip. Style: Nano Banana Pro premium aesthetic, Luxurious, soft glows, elegant gradients, high-contrast text block.`;
                }
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${API_KEY}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                        instances: [{ prompt: enhancedPrompt }],
                        parameters: { sampleCount: 1 }
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const predictions = result.predictions || [];
                    if (!predictions.length) throw new Error("No image generated");
                    
                    const base64Image = predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Image}`;
                    
                    setGeneratedImages(prev => ({ ...prev, [key]: imageUrl }));
                } catch (err) {
                    console.error("Error generating image:", err);
                    // FALLBACK: If API fails, we use a special flag to render the CSS fallback
                    setGeneratedImages(prev => ({ ...prev, [key]: 'error_fallback' }));
                } finally {
                    setGeneratingImages(prev => ({ ...prev, [key]: false }));
                }
            };

            const copyToClipboard = (text, sectionId) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopiedSection(sectionId);
                    setTimeout(() => setCopiedSection(null), 2000);
                } catch (err) { console.error('Failed to copy', err); }
                document.body.removeChild(textArea);
            };

            const MarkdownRenderer = ({ content }) => {
                if (!content) return null;
                return (
                    <div className="prose prose-slate max-w-none">
                        {content.split('\n').map((line, idx) => {
                            if (line.startsWith('### ')) return <h3 key={idx} className="text-xl font-bold mt-4 mb-2 text-slate-800">{line.replace('### ', '')}</h3>;
                            if (line.startsWith('## ')) return <h2 key={idx} className="text-2xl font-bold mt-6 mb-3 text-slate-800">{line.replace('## ', '')}</h2>;
                            if (line.startsWith('# ')) return <h1 key={idx} className="text-3xl font-bold mt-6 mb-4 text-slate-900">{line.replace('# ', '')}</h1>;
                            if (line.startsWith('- ')) return <li key={idx} className="ml-4 text-slate-700 mb-1">{line.replace('- ', '')}</li>;
                            if (line.trim() === '') return <br key={idx} />;
                            return <p key={idx} className="mb-3 text-slate-700 leading-relaxed">{line}</p>;
                        })}
                    </div>
                );
            };

            // Nano Banana Pro Fallback Graphic Component - Updated with Image Background
            const FallbackGraphic = ({ title, type }) => (
                <div className={`relative overflow-hidden w-full flex flex-col items-center justify-center text-center ${type === 'blog' ? 'aspect-video' : 'aspect-square'} bg-slate-900 group`}>
                    {/* Background Image Placeholder (Office/Professional vibe) */}
                    <img 
                        src="https://images.unsplash.com/photo-1497215728101-856f4ea42174?q=80&w=1200&auto=format&fit=crop" 
                        alt="Background" 
                        className="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:scale-105 transition-transform duration-700"
                    />
                    
                    {/* Dark overlay for readability */}
                    <div className="absolute inset-0 bg-black/30"></div>

                    {/* Gradient Strip Overlay - Nano Banana Pro Style */}
                    <div className="relative z-10 w-full max-w-[90%]">
                        <div className="nb-overlay p-6 rounded-xl shadow-2xl border border-white/20 backdrop-blur-md transform transition-all">
                            <h3 className="text-white text-xl md:text-2xl font-bold font-display leading-tight tracking-tight drop-shadow-lg">
                                {title}
                            </h3>
                        </div>
                    </div>
                    
                    <div className="absolute bottom-4 right-4 text-white/50 text-[10px] font-mono uppercase tracking-widest z-20">Nano Banana Pro</div>
                </div>
            );
